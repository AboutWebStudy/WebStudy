### 👉 JWT(Jason Web Token)의 무상태적 특성

---

- JWT의 주된 장점 중 하나는 서버 부하 감소와 무상태적 데이터 전송
- JWT는 발급 시점에 정보를 포함하고 있기 때문에, 클라이언트가 해당 토큰을 사용하는 동안 서버가 별도로 상태를 관리하지 않음
- 이로 인해 사용 중에 사용자 정보 등이 바뀌었을 때 문제가 생길 수 있음
    - JWT는 기본적으로 자체적으로 사용자 정보를 업데이트하지 않음
    - 예를 들어, 사용자의 역할(role)이 변경되었는데 토큰에 이전 역할이 포함되어 있다면, 서버는 여전히 잘못된 역할을 신뢰하게 됨
- 사용자가 중요한 정보를 변경하더라도 토큰이 만료되기 전까지는 변경된 정보를 반영할 수 없음
    - 토큰이 만료되어야 로그인 등을 통해 재발급 받기 때문
    <br>
    <br>

### 👉 문제가 될 수 있는 상황

---

- 사용자가 특정 리소스에 대한 접근 권한을 잃었는데 기존 JWT가 여전히 유효하다면 보안 문제가 발생할 수 있음
- 계정이 비활성화되었더라도 유효한 JWT를 사용하면 서버는 이를 검증하고 접근을 허용할 수 있음
- 이메일 주소나 사용자 이름 등 사용자의 정보가 변경되었는데, 클라이언트는 여전히 이전 정보를 사용하는 경우가 생길 수 있음
    - 정보 변경 시, 새로운 JWT 발급이 필요한데, 이 과정이 번거롭기 때문에 일부 개발자는 JWT를 단순 조회 키처럼 사용하기도 함
        - JWT에서 사용자 ID만 추출하고, 해당 ID로 서버(DB)에서 최신 사용자 정보를 다시 가져오는 방식으로 해결
        - ⇒ 이 경우, JWT의 주요 장점인 ‘서버에 부담 없이 정보 교환'이라는 의미가 퇴색됨
- 유효 기간 안에 토큰이 탈취되면, 이를 폐기하거나 변경할 방법이 없음
<br>
<br>

### 👉 해결 방안

---

- **JWT Access Token 유효 기간을 짧게 설정**
    - JWT의 exp(만료) 클레임을 짧게 설정하여, 사용자가 자주 새로운 토큰을 받아야 하도록 함
    - 이렇게 하면 변경 사항이 더 빨리 반영 됨
    - 클라이언트가 주기적으로 새 토큰을 요청해야 하므로 네트워크 트래픽이 증가할 수 있다는 단점이 있음
    <br>
- **토큰 무효화 관리**
    - 블랙리스트(Blacklist) 방식
        - 서버에서 특정 토큰을 무효화할 수 있는 블랙리스트를 유지
        - 사용자가 중요한 정보를 변경하면 기존 토큰을 블랙리스트에 추가
        - 무상태적인 JWT의 장점이 일부 상실되고, 서버 측에서 추가적인 저장소와 로직이 필요하다는 단점이 생김
    - Refresh Token 사용
        - JWT와 함께 Refresh Token을 사용하여, 일정 시간마다 새 토큰을 발급받게 함
        - 서버는 Refresh Token을 확인하여 사용자의 상태를 동기화할 수 있음
        - Refresh Token은 유용하지만, 탈취 시 장기적으로 악용될 가능성이 있기 때문에 IP 제한, 장치 식별, 사용자 세션 관리 등의 추가적인 보안 조치를 병행하면 좋음
        <br>
- **토큰 페이로드 축소 및 상태 저장**
    - JWT에 민감한 정보를 포함하지 않고, 서버에서 해당 정보를 별도로 저장 및 관리
    - 예를 들어, 토큰에는 사용자 ID만 포함하고 나머지 정보는 데이터베이스를 조회하여 확인하는 방식
    - 사용자 정보가 변경되더라도 최신 상태를 유지할 수 있지만, JWT의 주요 장점인 무상태적 특성이 감소함
- 버전 클레임 추가
    - JWT에 version 필드를 추가하여, 사용자가 정보를 변경할 때마다 사용자 데이터의 버전을 증가시킴
    - 서버는 해당 버전을 확인하여 변경 사항을 반영할 수 있음
    - 사용자 정보 변경 시 JWT 재발급 로직이 필요
    <br>
    <br>

### 👉 권장 접근 방식

---

- 민감한 정보를 JWT에 포함하지 않기
    - 예를 들어, 역할(role)이나 권한 정보를 JWT에 직접 포함하지 않고, 토큰 발급 시 서버에서 확인하도록 함
- Refresh Token과 조합하여 사용
    - 짧은 유효 기간을 가진 액세스 토큰과 장기 유효 기간의 Refresh Token을 함께 사용하면 보안과 편의성의 균형을 유지할 수 있음
- 실시간으로 중요한 정보가 업데이트되는 경우는 서버 상태와 동기화하는 방법을 사용하기
    - 예를 들어, 사용자 계정 정지 시 즉각적인 반영이 필요하다면 세션 저장소나 블랙리스트를 활용하는 방식
- 캐시와 DB 조회 혼합 사용
    - Redis와 같은 캐시를 사용하여 빠른 데이터 조회와 상태 확인이 가능하도록 하여 실시간 동기화 문제를 해결
    - 탈취 등의 문제 해결을 해결하기 위해서 Redis로 JTI(JWT ID) 또는 세션 정보를 저장해서 검증하는 방식도 있는데, 근본적인 해결책이라기 보다는 무효화 하기 더 편리하게 만드는 방식
