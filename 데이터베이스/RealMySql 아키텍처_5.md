# MyISAM 스토리지 엔진 아키텍처

## 키 캐시

InnoDB의 버퍼 풀과 비슷한 역할을 하는 것이 MyISAM의 키 캐시이다. 하지만 키 캐시는 인덱스만을 대상으로 작동하며, 인덱스의 디스크 쓰기 작업에 대해서만 부분적으로 버퍼링 역할을 한다.

## 운영체제의 캐시 및 버퍼

MyISAM 테이블의 인덱스는 키 캐시를 이용해 디스크를 검색하지 않고도 충분히 빠르게 검색할 수 있다. 하지만 테이블 데이터에 의해서는 디스크로부터의 I/O를 해결해 줄 만한 어떠한 캐시나 버퍼링 기능도 가지고 있지 않다. 또, MyISAM의 캐시 공간은 남는 메모리를 사용하는 것이 기본 원칙이기에 캐시 공간을 위해 충분한 메모리를 비워둬야 한다.

## 데이터 파일과 프라이머리 키(인덱스) 구조

MyISAM 테이블을 프라이머리 키에 의한 클러스터링 없이 데이터 파일이 힙(Heap) 공간처럼 활용된다. 즉 MyISAM 테이블에 레코드는 프라이머리 키 값과 무관하게 INSERT되는 순서대로 데이터 파일에 저장된다.

MyISAM 테이블에서 ROWID는 가변 길이와 고정 길이의 두 가지 방법으로 저장될 수 있다.

- 고정 길이 ROWID
    - 레코드가 INSERT된 순번이 ROWID로 사용된다.
- 가변 길이 ROWID
    - MyISAM 테이블을 생성할 때 MAX_ROWS 옵션을 설정하지 않으면 ROWID가 2바이트부터 7바이트까지의 가변적인 ROWID를 갖게된다.

---

# MySQL 로그 파일

## 에러 로그 파일

MySQL이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일이다. 에러 로그 파일의 위치는 MySQL 설정파일(my.cnf)에서 log_error라는 이름의 파라미터로 정의된 경로에 생성된다.

### MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지

MySQL의 설정 파일을 변경하거나 데이터베이스가 비정상적으로 종료된 이후 다시 시작할 때는 반드시 MySQL 에러 로그 파일을 통해 설정된 변수의 이름이나 값이 명확하게 설정되고 의도한 대로 적용됐는지 확인해야 한다. 새로 변경하거나 추가한 파라미터에 대한 특별한 에러나 경고성 메시지가 없다면 정상적으로 적용된 것이다.

### 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지

InnoDB의 경우에는 MySQL 서버가 비정상적 또는 강제 종료됐다면 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터가 있다면 다시 기록하는 재처리 작업을 하고, 문제로 인해 복구되지 않으면 메시지를 출력하고 MySQL이 종료된다.

### 쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지

쿼리 도중 발생하는 문제점은 사전 예방이 어려우며, 주기적으로 에러 로그 파일을 검토하는 과정에서 알게 된다.

### 비정상적으로 종료된 커넥션 메시지(Aborted connection)

클라이언트 애플리케이션에서 정상적으로 접속 종료를 하지 못하고 프로그램이 종료된 경우 기록된다.

이 메시지가 아주 많이 기록되었다면 애플리케이션의 커넥션 종료 로직을 검토해볼 필요가 있다.

### InnoDB의 모니터링 또는 상태 조회 명령(SHOW ENGINE INNODB STATUS같은)의 결과 메시지

InnoDB의 테이블, 락, 엔진 상태를 조회하는 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록한다. 때문에 모니터링을 사용한 이후에는 다시 비활성화해야한다.

### MySQL의 종료 메시지

MySQL이 아무도 모르게 종료돼 있거나 아무도 모르게 재시작될 때 원인을 알 수 있는 방법은 MySQL이 마지막으로 종료되면서 출력한 메시지를 확인해야한다.

누군가가 서버를 종료시킨 것이라면 “ReceivedSHUTDOWN from user …’ 이라는 메시지를 확인할 수 있을 것이고, 아무런 종료 관련 메시지가 없다면 스택 트레이스(16진수 주소값이 잔뜩 출력)와 같은 내용이 출력되었을 때는 MySQL 서버가 세그먼테이션 폴트로 비정상 종료된 것으로 판단할 수 있다.

## 제너럴 쿼리 로그 파일(제너럴 로그 파일, General log)

MySQL 서버에서 실행되는 쿼리로 어떤 것들이 있는지 전체 목록을 뽑아서 검토할 수 있는데, 이 때 쿼리 로그를 활성화해서 쿼리를 쿼리 로그 파일로 기록하게 한 후 검토해야 한다.

쿼리 로그를 파일로 저장할지 테이블로 저장할지는 log_output 파라미터로 결정된다.

저장되는 위치를 확인하려면

```java
mysql> SHOW GLOBAL VARIABLES LIKE 'general_log_file';
```

명령을 통해 테이블에 저장되는지, 파일을 저장하는지 확인할 수 있다.

## 슬로우 쿼리 로그

MySQL 서버의 쿼리 튜닝은 크게 서비스가 적용되기 전에 전체적으로 튜닝하는 경우와 운영 중에 성능 저하를 검사할 때 정기점검을 위한 튜닝으로 나뉘는데

전자의 경우는 모두 튜닝하면 되지만, 후자의 경우에는 어떤 쿼리가 문제인지 파악이 어렵기 때문에 이럴 때 사용하는 것이 슬로우 쿼리 로그이다.

슬로우 쿼리 로그 파일에는 `long_query_time` 시스템 변수에 설정한 시간 이상의 시간이 소요된 쿼리가 기록된다. 쿼리가 정상적으로 실행이 완료돼야 슬로우 쿼리 로그에 기록된다.

### 슬로우 쿼리 통계

분석 결과의 최상단에 표시되며, 모든 쿼리를 대상으로 슬로우 쿼리 로그의 실행 시간, 잠금 대기 시간 등에 대해 평균 및 최소/최대 값을 표시한다.

### 실행 빈도 및 누적 실행 시간순 랭킹

pt-query-digest명령 실행 시 —order-by 옵션으로 정렬 순서를 응답시간이나 실행횟수 등 우선순위를 통해 볼 수 있다.

### 쿼리별 실행 횟수 및 누적 실행 시간 상세 정보

Query ID별 쿼리를 쿼리 랭킹에 표시된 순서대로 자세한 내용을 보여준다. 랭킹별 쿼리에서는 대상 테이블에 대해 어떤 쿼리인지만을 표시하는데, 실제 상세한 쿼리 내용은 개별 쿼리의 정보를 확인해야한다.
