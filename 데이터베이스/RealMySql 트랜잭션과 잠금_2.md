# 엔진의 잠금

- MySQL 엔진의 잠금레벨
    - 모든 스토리지 엔진에 영향을 미침
- 스토리지 엔진의 잠금레벨
    - 스토리지 엔진 간 상호 영향을 미치지 않음

## MySQL엔진 잠금

### 글로벌 락

`FLUSH TABLES WITH READ LOCK`명령을 통해 글로벌 락을 걸 수 있으며, MySQL에서 제공하는 가장 범위가 큰 잠금이다. 글로벌 락이 걸렸을 때 MySQL 서버 전체의 값을 사용이 불가능하다.

MySQL 8.0 이전에는 트랜잭션을 지원하지 않았기 때문에 일관된 백업을 받아야할 때는 글로벌 락을 사용했지만, 현재는 **InnoDB를 주로 사용하고, 트랜잭션을 지원**하기에 완전한 글로벌 락이 백업서버에서의 Xtrabackup, Enterprise Backup 등 **백업 툴을 위한 락 용도**로 지원된다.

### 글로벌-백업 툴과 백업 락의 관계

특정 세션에서는 백업 락을 획득하면 모든 세션에서 다음과 같이 테이블의 스키마나 사용자의 인증 관련 정보를 변경할 수 없게 된다.

- 데이터베이스 및 테이블 등 모든 객체 생성 및 변경, 삭제
- REPAIR TABLE과 OPTIMIZE TABLE 명령
- 사용자 관리 및 비밀번호 변경

하지만, 백업 락은 테이블의 데이터 변경은 허용된다.

MySQL은 백업툴이 실행되고 있을 때 DDL명령이 들어오면 에러를 발생시키는데, 이를 방어하기 위해 락을 사용한다. DDL명령이 완료 된 이후 락을 해제시키고 다시 백업하는 것이다.

## 테이블 락

개별 테이블 단위로 설정되며, `명시적, 묵시적`으로 사용할 수 있다. `LOCK TABLES table_name [ READ | WRITE ]` 명령으로 명시적인 잠금이 가능하고, MyISAM, InnoDB 엔진이 설정 가능하다.

묵시적인 잠금이 걸릴 때

- DML : MyISAM, MEMORY 테이블
- DDL : InnoDB, MyISAM, MEMORY 테이블

## 네임드 락

`GET_LOCK()` 함수를 이용해 임의의 문자열에 대해 잠금을 설정할 수 있다. 테이블이나 레코드가 아니라 단순히 사용자가 지정한 문자열을 획득하고 반납하는 잠금이다. mylock의 잠금이 되어있는지 확인하는 기능이다.

## 메타데이터 락

메타데이터 락은 데이터베이스 객체의 이름이나 구조를 변경할 때 획득하는 잠금이다.

- 명시적획득 불가능
- 테이블의 이름을 변경할 때 자동으로 획득하는 잠금 ex) `RENAME TABLE tab_a TO tab_b`
- 메타데이터 잠금 + InnoDB 트랜잭션
